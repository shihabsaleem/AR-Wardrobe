<!DOCTYPE html>
<html>
<head>
    <title>Web AR Hat Filter</title>
    <style>
        #videoElement {
            width: 100%;
            height: auto;
            transform: scaleX(-1); /* Flip video horizontally for mirroring effect */
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>
<body>
    <video id="videoElement"></video>
    <canvas id="canvasElement"></canvas>

    <script>
        // Access the user's camera
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(function (stream) {
                var video = document.getElementById("videoElement");
                video.srcObject = stream;
                video.play();

                // Load the face tracking model
                var faceTracker = new tracking.ObjectTracker("face");
                faceTracker.setInitialScale(4);
                faceTracker.setStepSize(2);
                faceTracker.setEdgesDensity(0.1);

                tracking.track("#videoElement", faceTracker, { camera: true });

                // Apply the hat filter when a face is detected
                faceTracker.on("track", function (event) {
                    var canvas = document.getElementById("canvasElement");
                    var context = canvas.getContext("2d");
                    context.clearRect(0, 0, canvas.width, canvas.height);

                    event.data.forEach(function (rect) {
                        // Draw a rectangle around the detected face
                        context.strokeStyle = "#FF0000";
                        context.lineWidth = 2;
                        context.strokeRect(rect.x, rect.y, rect.width, rect.height);

                        // Draw the hat filter image
                        var filterImage = new Image();
                        filterImage.src = "https://i.imgur.com/QbU8wdx.png";

                        // Calculate the position and size of the hat filter
                        var hatWidth = rect.width * 1.5;
                        var hatHeight = rect.height * 0.8;
                        var hatX = rect.x + rect.width / 2 - hatWidth / 2;
                        var hatY = rect.y - hatHeight * 0.7;

                        // Draw the hat filter image on the canvas
                        context.drawImage(filterImage, hatX, hatY, hatWidth, hatHeight);
                    });
                });
            })
            .catch(function (error) {
                console.error("Error accessing the camera: ", error);
            });
    </script>
</body>
</html>











////////////////////////////////////////////////////////////////////////////
<!DOCTYPE html>
<html>
  <head>
    <title>Face Filter</title>
  </head>

  <body>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.0.0/lib/p5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/clmtrackr@1.1.2/build/clmtrackr.min.js"></script>
  </body>

  <script>
    let outputWidth;
    let outputHeight;

    let faceTracker; // Face Tracking
    let videoInput;

    let imgSpidermanMask; // Spiderman Mask Filter
    let imgDogEarRight, imgDogEarLeft, imgDogNose; // Dog Face Filter

    let selected = -1; // Default no filter

    /*
     * **p5.js** library automatically executes the `preload()` function. Basically, it is used to load external files. In our case, we'll use it to load the images for our filters and assign them to separate variables for later use.
     */
    function preload() {
      // Spiderman Mask Filter asset
      imgSpidermanMask = loadImage("a.png");

      // Dog Face Filter assets
      // imgDogEarRight = loadImage("https://i.ibb.co/bFJf33z/dog-ear-right.png");
      // imgDogEarLeft = loadImage("https://i.ibb.co/dggwZ1q/dog-ear-left.png");
      // imgDogNose = loadImage("https://i.ibb.co/PWYGkw1/dog-nose.png");
    }

    /**
     * In p5.js, `setup()` function is executed at the beginning of our program, but after the `preload()` function.
     */
    function setup() {
      const maxWidth = Math.min(windowWidth, windowHeight);
      pixelDensity(1);
      outputWidth = maxWidth;
      outputHeight = maxWidth * 0.75; // 4:3

      createCanvas(outputWidth, outputHeight);

      // webcam capture
      videoInput = createCapture(VIDEO);
      videoInput.size(outputWidth, outputHeight);
      videoInput.hide();

      // select filter
      const sel = createSelect();
      const selectList = ["Spiderman Mask", "Dog Filter"]; // list of filters
      sel.option("Select Filter", -1); // Default no filter
      for (let i = 0; i < selectList.length; i++) {
        sel.option(selectList[i], i);
      }
      sel.changed(applyFilter);

      // tracker
      faceTracker = new clm.tracker();
      faceTracker.init();
      faceTracker.start(videoInput.elt);
    }

    // callback function
    function applyFilter() {
      selected = this.selected(); // change filter type
    }

    /*
     * In p5.js, draw() function is executed after setup(). This function runs inside a loop until the program is stopped.
     */
    function draw() {
      image(videoInput, 0, 0, outputWidth, outputHeight); // render video from webcam

      // apply filter based on choice
      switch (selected) {
        case "-1":
          break;
        case "0":
          drawSpidermanMask();
          break;
        case "1":
          drawDogFace();
          break;
      }
    }

    // Spiderman Mask Filter
    function drawSpidermanMask() {
      const positions = faceTracker.getCurrentPosition();
      if (positions !== false) {
        push();
        const wx = Math.abs(positions[13][0] - positions[1][0]) * 1.2; // The width is given by the face width, based on the geometry
        const wy =
          Math.abs(
            positions[7][1] - Math.min(positions[16][1], positions[20][1])
          ) * 1.2; // The height is given by the distance from nose to chin, times 2
        translate(-wx / 2, -wy / 2);
        image(imgSpidermanMask, positions[62][0], positions[62][1], wx, wy); // Show the mask at the center of the face
        pop();
      }
    }

    // Dog Face Filter
    function drawDogFace() {
      const positions = faceTracker.getCurrentPosition();
      if (positions !== false) {
        if (positions.length >= 20) {
          push();
          translate(-100, -150); // offset adjustment
          image(imgDogEarRight, positions[20][0], positions[20][1]);
          pop();
        }

        if (positions.length >= 16) {
          push();
          translate(-20, -150); // offset adjustment
          image(imgDogEarLeft, positions[16][0], positions[16][1]);
          pop();
        }

        if (positions.length >= 62) {
          push();
          translate(-57, -20); // offset adjustment
          image(imgDogNose, positions[62][0], positions[62][1]);
          pop();
        }
      }
    }

    function windowResized() {
      const maxWidth = Math.min(windowWidth, windowHeight);
      pixelDensity(1);
      outputWidth = maxWidth;
      outputHeight = maxWidth * 0.75; // 4:3
      resizeCanvas(outputWidth, outputHeight);
    }
  </script>
</html>
